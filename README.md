# 17dame Connect Tool for Unity
17dame connect tool: ConnectTool provides registration, login, Authorize,get access token, refresh token and user information.
## Table of Contents

- [Installation](#installation)
    - [Unity Package](#unity-package) 
- [Setting](#setting)
- [Flow](#operating)
- [ConnectTool function](#function) 
    - [SendRegisterData](#SendRegisterData)
    - [SendLoginData](#SendLoginData)
    - [OpenAuthorizeURL](#OpenAuthorizeURL)
    - [GetConnectToken_Coroutine](#GetConnectToken_Coroutine)
    - [GetRefreshToken_Coroutine](#GetRefreshToken_Coroutine)  
- [Model](#model)
 

## Installation
Required Unity 2022.3 or later.
 
## Setting
- Open File > Build Settings > Player Settings > Build
    Check the option `Custom Main Manifest`
- Open \Assets\Plugins\Android, AndroidManifest.xml and add:
```xml
<intent-filter>
  <action android:name="android.intent.action.VIEW" />
  <category android:name="android.intent.category.DEFAULT" />
  <category android:name="android.intent.category.BROWSABLE" />
  <data android:scheme="{{ Get from redirect_uri's scheme }}" android:host="connectlink" />
</intent-filter>
```  
- redirect_uri : Open specific scene, for example : `{{ Get from redirect_uri's scheme }}://connectlink?connectscene`


## Flow
Here is a simple flow chart:
```mermaid 
graph TD;
    Register-->Login;
    A(OpenAuthorizeURL) -->|request login| B1(onDeepLinkActivated);
    B1(onDeepLinkActivated)-->|get Code | D(GetConnectToken_Coroutine ); 
    D(GetConnectToken_Coroutine ) -->|get Access token |s(GetMe_Coroutine);
     D(GetConnectToken_Coroutine )--> C{Token expired?}
    C -->|yet| s(GetMe_Coroutine)
    C -->|expired| Rf[GetRefreshToken_Coroutine]
    Rf[GetRefreshToken_Coroutine]-->|get Access token |s(GetMe_Coroutine) 
```
 
Send Authorize to get code. Please refer to ConnectSample to insert Awake().
```csharp 
private void Awake()
    {
        if (Instance == null)
        {
            Instance = this;
            Application.deepLinkActivated += onDeepLinkActivated;
            if (!string.IsNullOrEmpty(Application.absoluteURL))
            {
                onDeepLinkActivated(Application.absoluteURL);
            } 
            DontDestroyOnLoad(gameObject);
        }
        else
        {
            Destroy(gameObject);
        }
    } 
```

## ConnectTool function
- Create `ConnectTool` and `ConnectTool.ConnectBasic`, parameters must be filled in:
```csharp
_connectTool = new ConnectTool( 
  state,
  requestNumber,
  redirect_uri,
  RSAxmlStr
); 
_connectTool.connectBasic = new ConnectBasic()
{
    client_id = "",
    X_Developer_Id = "",
    client_secret = "",
    Game_id = "",
    referralCode = "",
};
```
>[!NOTE]  
> RSAxmlStr : Please convert RSA key to xml format, because .NET 2 does not support rsa.ImportRSAPrivateKey. Refer this [online tool](https://raskeyconverter.azurewebsites.net/PemToXml?handler=ConvertXML)
- state : Please fill in what you want to verify,`state` can be query through redirect_uri.
- requestNumber :The identification generated by game developer, It must be Universally Unique Identifier (UUID) format.
         
### SendRegisterData　
- Create ConnectTool.CreateAccountInitData object first. 
```csharp  
_connectTool.CreateAccountInitData(_email,_password);
```
- `email`,`Password` are required.
> [!IMPORTANT]  
> - Password must have at least one `uppercase letter`/`lowercase letter`/`symbol`. (exp: Zy-11111) 
> - Password length must be 6 or more.
- Send ConnectTool.SendRegisterData().
- Return StatusCode check.
  
### SendLoginData　
- Create ConnectTool.CreateAccountInitData object first; 
```csharp  
_connectTool.CreateAccountInitData(_email,_password);
```
- `email`,`Password` are required.
- Send ConnectTool.SendLoginData().
- Return StatusCode check.

### OpenAuthorizeURL　 
- `connectBasic.client_id` is required. 
- Open host page to log in.
- You will get `code` from redirect_uri's parameter after logs in.
```csharp  
private void onDeepLinkActivated(string url)
    {
        Uri codeUri = new Uri(url);
        string code = HttpUtility.ParseQueryString(codeUri.Query).Get("code"); 
        _connectTool.code = code;
 
        bool validScene = false;
        string sceneName = url.Split('?')[1];
        if (sceneName.Contains("connectscene"))
        {
            validScene = true;
        } 
        if (validScene) SceneManager.LoadScene("connectscene"); 
    }
```
Step 
1. Execute Authorize through ConnectTool.
2. Open Login page.
3. Retrieve code through onDeepLinkActivated.
4. Execute GetConnectToken_Coroutine to obtain access_token.
   
### GetConnectToken_Coroutine 
- `connectTool.code` is required. 
- `connectTool.code` can be obtained through ConnectTool set or onDeepLinkActivated function.
- Return ConnectTokenModel. 
 
### GetRefreshToken_Coroutine  
- `connectTool.refresh_token` is required.  
- Return ConnectTokenModel 

### GetMe_Coroutine 
- `connectTool.access_token` is required.  
- Return MeInfo.
 

## Model 
```mermaid 
classDiagram 
    class ConnectBasic{
      +client_id 
      +X_Developer_Id  
      +client_secret  
      +Game_id  
      +referralCode  
    }

    class AccountInitRequest{
      +email 
      +password  
    }

    class ConnectToken{
      +access_token 測試 
      +token_type 固定 Bearer
      +expires_in 有效時間 (秒) 
      +scope 
      +refresh_token  refresh時帶入
    }
    
    class MeData{
      +email
      +nickName
      +avatarUrl
      +eCoin
      +rebate
    }

    MeInfo<|-- MeData
    class MeInfo{
      +MeData data
      +StatusCode status
      +message
      +requestNumber
    }

```
     
 

 


